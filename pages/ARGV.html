<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>XREAL — ANDROID NAILER</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
:root{--bg:#05070a;--cy:#00d4ff;--gr:#39ff14;--dm:#3a4a5a;--tx:#c8d8e8;--bdr:rgba(0,212,255,0.15);}
body{background:var(--bg);color:var(--tx);font-family:'JetBrains Mono',monospace;height:100dvh;margin:0;display:grid;grid-template-rows:50px 1fr 150px;overflow:hidden;}
header{padding:0 20px;display:flex;align-items:center;background:#0a0d14;border-bottom:1px solid var(--bdr);color:var(--cy);font-weight:700;letter-spacing:2px;}
main{display:grid;grid-template-columns:1fr;position:relative;}
#cvw{background:radial-gradient(circle at 50% 40%,#0d1b2a 0%,#05070a 70%);}
canvas{width:100%; height:100%;}
#controls{position:absolute; bottom:20px; left:20px; right:20px; display:flex; gap:10px;}
.hbtn{flex:1; padding:12px; background:rgba(0,212,255,0.1); border:1px solid var(--cy); color:var(--cy); font-family:'JetBrains Mono'; font-weight:700; cursor:pointer;}
#con{background:#000; padding:10px; font-size:10px; overflow-y:auto; color:var(--gr); border-top:1px solid var(--bdr);}
</style>
</head>
<body>
<header>XREAL // ANDROID_IMU</header>
<main id="cvw">
    <canvas id="c"></canvas>
    <div id="controls">
        <button class="hbtn" onclick="initAndroidUSB()">CONNECT GLASSES</button>
        <button class="hbtn" onclick="recentre()">RE-CENTRE</button>
    </div>
</main>
<div id="con">Ready for Android WebUSB...</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
const con = document.getElementById('con');
function clog(m){ con.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${m}</div>`; con.scrollTop = con.scrollHeight; }

// ── THREE.JS ─────────────────────────────────────────────────
const scene = new THREE.Scene();
const cam = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 100);
cam.position.z = 5;
const rend = new THREE.WebGLRenderer({canvas:document.getElementById('c'), antialias:true, alpha:true});
const G = new THREE.Group();
G.add(new THREE.Mesh(new THREE.BoxGeometry(2,0.4,0.1), new THREE.MeshPhongMaterial({color:0x111111})));
scene.add(G); scene.add(new THREE.AmbientLight(0xffffff, 0.8));
function res(){ rend.setSize(window.innerWidth, window.innerHeight); cam.aspect=window.innerWidth/window.innerHeight; cam.updateProjectionMatrix(); }
window.onresize=res; res();

// ── ANDROID USB ENGINE ──────────────────────────────────────
let usbDev, lastT=0, gyroQ=new THREE.Quaternion(), refQ=new THREE.Quaternion();
const SCALE = (Math.PI/180)*(2000/32768);

async function initAndroidUSB(){
    try {
        usbDev = await navigator.usb.requestDevice({filters:[{vendorId:0x3318, productId:0x0424}]});
        await usbDev.open();
        // Android identifies the IMU on Interface 3 or 4
        try { await usbDev.claimInterface(3); clog("Claimed Interface 3"); }
        catch(e) { await usbDev.claimInterface(4); clog("Claimed Interface 4"); }

        clog("Sending Activation...");
        const magic = new Uint8Array([0xaa, 0xc5, 0xd1, 0x21, 0x42, 0x00, 0x19, 0x01]);
        await usbDev.controlTransferOut({
            requestType: 'class', recipient: 'interface', request: 0x09, value: 0x0300, index: 3
        }, magic).catch(()=>{});

        readLoop();
    } catch(e){ clog("Error: " + e.message); }
}

async function readLoop(){
    while(usbDev && usbDev.opened){
        try {
            // Endpoint 4 is the standard interrupt IN for XREAL IMU
            const result = await usbDev.transferIn(4, 64);
            if(result.data) parse(result.data);
        } catch(e){ break; }
    }
}

function parse(dv){
    const ts = dv.getUint32(10, true);
    if(!ts || !lastT){ lastT=ts; return; }
    const dt = (ts-lastT)/1000000; lastT=ts;
    const gx = dv.getInt16(26, true)*SCALE;
    const gy = dv.getInt16(28, true)*SCALE;
    const gz = dv.getInt16(30, true)*SCALE;

    if(Math.abs(gx)>0.005 || Math.abs(gy)>0.005){
        const dq = new THREE.Quaternion().setFromEuler(new THREE.Euler(gx*dt, gy*dt, gz*dt, 'XYZ'));
        gyroQ.multiply(dq);
        G.quaternion.copy(refQ).multiply(gyroQ);
    }
}
function recentre(){ refQ.copy(gyroQ).invert(); clog("Re-centred."); }
function animate(){ requestAnimationFrame(animate); rend.render(scene, cam); }
animate();
</script>
</body>
</html>
